\begin{section}{Consultas}

Para la resoluci\'on de este trabajo se decidi\'o utilizar el motor de base de datos $SQLite$ como base para su implementaci\'on dado que es m\'as liviano para correr y su uso es bastante intuitivo. Puede soportar una cantidad abundate de datos (aproximadamente 2 teras) y tambi\'en utiliza llamadas simples a subrutinas y funciones lo que reduce la latencia en el acceso a la base de datos, debido a que las llamadas a funciones son más eficientes que la comunicación entre procesos. 

A continuaci\'on se encuentra el script de generaci\'on de tablas:

\begin{lstlisting}[language=SQL]

import os
import sqlite3

os.system('rm ../test/test.db')
os.system('sqlite3 ../test/test.db < crear_base.sql')

conn = sqlite3.connect('../test/test.db')

tables = ['Cargo', 'Territorio', 'Votante', 'Candidato', 
	'VotacionEleccion', 'VotacionCandidato', 'VotacionConsultaPopular', 
	'Camioneta', 'Centro', 'Mesa', 'PartidoPolitico', 'RigePara', 
	'SePostulaA', 'ConsultaPopular', 'ViveEn', 
	'VotacionPorMesa', 'Vota', 'EsFiscal', 'Voto', 'VotoCandidato', 
	'VotoConsultaPopular', 'VotaEn']


conn.execute('PRAGMA foreign_keys = ON')
for table in tables:
	csv = open('../test/csvs/\%s.csv' \% (table))
	for line in csv:
		
		values = line.split(",")		
		for i in range(len(values)):
			v = values[i]			
			v = v.lstrip()
			v = v.rstrip()						
			if not (v.upper() == "NULL") and not 
					v[0].isdigit() and v[0] != '"' and v[0] != "'":
				values[i] = '"' + v + '"'
		
		line = ','.join(values)				
		print 'INSERT INTO \%s VALUES (\%s)' \% (table, line)
		conn.execute('INSERT INTO \%s VALUES 
									(\%s)' \% (table, line))
conn.commit()
conn.close()

\end{lstlisting} 

\end{section}

\begin{section}{Consultas}


Consulta 1: Obtener los ganadores de las elecciones transcurridas en el \'ultimo año.

\begin{lstlisting}[language=SQL]

SELECT v.nombre
FROM Votante v, Candidato can, VotacionCandidato vc, SePostulaA spa
WHERE v.dni = can.dni
AND can.dni = spa.dni
AND vc.idEleccion IN (SELECT vc2.idEleccion
                      FROM VotacionEleccion ve, VotacionCandidato vc2
                      WHERE ve.idEleccion = vc2.idEleccion
                      AND fecha >= ( SELECT MAX(fecha)
                                     FROM VotacionEleccion))
AND vc.idEleccion = spa.idEleccion
AND spa.cantVotos = (SELECT MAX(spa2.cantVotos)
                     FROM SePostulaA spa2
                     WHERE spa2.idEleccion = vc.idEleccion);

\end{lstlisting} 

Consulta 2: Consultar las 5 personas que m\'as tarde fueron a votar antes de terminar la votaci\'on por cada centro electoral en na elecci\'on.

\begin{lstlisting}[language=SQL]

SELECT cen.direccion, vot.dni
FROM Vota v, Votante vot, Mesa m, Centro cen
WHERE v.idMesa = m.idMesa
AND vot.dni = v.dni
AND m.idCentro = cen.idCentro
AND v.idEleccion IN (SELECT ve.idEleccion
                     FROM VotacionEleccion ve
                     WHERE fecha >= (SELECT MAX(fecha)
                                     FROM VotacionEleccion))
AND vot.dni IN (SELECT vot1.dni
                FROM Votante vot1, Vota v1, Mesa m1
                WHERE v1.idMesa = m1.idMesa
                AND m1.idCentro = cen.idCentro
                AND vot1.dni = v1.dni
                ORDER BY hora DESC
                LIMIT 5)
ORDER BY direccion,hora DESC;


\end{lstlisting} 

Consulta 3: Consultar quienes fueron los partidos pol\'iticos que obtuvieron m\'as del 20$\%$ en las \'ultimas 5 elecciones provinciales a gobernador.

\begin{lstlisting}[language=SQL]

SELECT pp.nombre
FROM PartidoPolitico pp, SePostulaA spa, Candidato can, Cargo c, VotacionCandidato vc
WHERE pp.idPartido = spa.idPartido
AND can.dni = spa.dni
AND spa.idEleccion = vc.idEleccion
AND vc.idEleccion IN (SELECT ve.idEleccion
                      FROM VotacionCandidato vc2, VotacionEleccion ve, Cargo c2
                      WHERE vc2.idEleccion = ve.idEleccion
                      AND c2.idCargo = vc2.idCargo
                      AND c2.nombre LIKE 'Gobernador'
                      ORDER BY ve.fecha DESC
                      LIMIT 5)
AND vc.idCargo = c.idCargo
AND c.nombre LIKE 'Gobernador'
AND spa.cantVotos > (SELECT SUM(spa2.cantVotos)*0.2
                     FROM SePostulaA spa2
                     WHERE spa2.idEleccion = vc.idEleccion);

\end{lstlisting} 


\end{section}
